# AI赋能职教视频个性化教学系统 - 数据库设计文档

## 文档信息
- **版本**: v1.0
- **编写日期**: 2025-01-25
- **编写人**: 周东吴（队长）
- **数据库类型**: PostgreSQL（推荐）/ MySQL
- **文档状态**: 初稿

---

## 1. 数据库ER图

### 1.1 ER图（Mermaid格式）

```mermaid
erDiagram
    User ||--o{ Video : "上传"
    User ||--o{ WatchEvent : "产生"
    User ||--o{ Mastery : "拥有"
    User ||--|| LearningPath : "拥有"
    
    Video ||--o{ KnowledgePoint : "包含"
    
    KnowledgePoint ||--o{ Resource : "拥有"
    KnowledgePoint ||--o{ WatchEvent : "关联"
    KnowledgePoint ||--o{ Mastery : "关联"
    KnowledgePoint ||--o{ KnowledgePointDependency : "前置依赖(source)"
    KnowledgePoint ||--o{ KnowledgePointDependency : "前置依赖(target)"
    
    Resource ||--o{ Exercise : "包含"
    Resource ||--o{ ResourcePush : "推送"
    
    User ||--o{ ResourcePush : "接收"
    
    User {
        int id PK
        string username UK
        string email UK
        string password
        string role
        string real_name
        string avatar_url
        datetime created_at
        datetime updated_at
    }
    
    Video {
        int id PK
        int uploader_id FK
        string title
        string file_path
        float duration
        string status
        string description
        datetime upload_time
        datetime created_at
        datetime updated_at
    }
    
    KnowledgePoint {
        int id PK
        int video_id FK
        string name
        float start_time
        float end_time
        string summary
        json keywords
        string difficulty
        string type
        datetime created_at
        datetime updated_at
    }
    
    WatchEvent {
        int id PK
        int user_id FK
        int knowledge_point_id FK
        string event_type
        float timestamp
        float duration
        json metadata
        datetime created_at
    }
    
    Mastery {
        int id PK
        int user_id FK
        int knowledge_point_id FK
        string status
        float mastery_score
        datetime last_study_time
        datetime created_at
        datetime updated_at
    }
    
    Resource {
        int id PK
        int knowledge_point_id FK
        string type
        string title
        text content
        json metadata
        float quality_score
        datetime created_at
        datetime updated_at
    }
    
    Exercise {
        int id PK
        int resource_id FK
        string question
        json options
        string correct_answer
        text explanation
        string difficulty
        datetime created_at
        datetime updated_at
    }
    
    LearningPath {
        int id PK
        int user_id FK UK
        json knowledge_point_sequence
        int current_position
        datetime created_at
        datetime updated_at
    }
    
    KnowledgePointDependency {
        int id PK
        int source_kp_id FK
        int target_kp_id FK
        string relation_type
        float confidence
        datetime created_at
    }
    
    ResourcePush {
        int id PK
        int user_id FK
        int resource_id FK
        int knowledge_point_id FK
        string push_status
        datetime push_time
        datetime read_time
        string feedback
        datetime created_at
        datetime updated_at
    }
    
    Class {
        int id PK
        string name
        string description
        int teacher_id FK
        datetime created_at
        datetime updated_at
    }
    
    ClassStudent {
        int id PK
        int class_id FK
        int student_id FK
        datetime joined_at
    }
```

---

## 2. 表结构设计

### 2.1 User（用户表）

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'student', -- student, teacher, admin
    real_name VARCHAR(50),
    avatar_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

### 2.2 Video（视频表）

```sql
CREATE TABLE videos (
    id SERIAL PRIMARY KEY,
    uploader_id INTEGER NOT NULL,
    title VARCHAR(200) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    duration FLOAT, -- 视频时长（秒）
    status VARCHAR(20) DEFAULT 'pending', -- pending, parsing, completed, failed
    description TEXT,
    upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (uploader_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_videos_uploader ON videos(uploader_id);
CREATE INDEX idx_videos_status ON videos(status);
CREATE INDEX idx_videos_upload_time ON videos(upload_time);
```

### 2.3 KnowledgePoint（知识点表）

```sql
CREATE TABLE knowledge_points (
    id SERIAL PRIMARY KEY,
    video_id INTEGER NOT NULL,
    name VARCHAR(200) NOT NULL,
    start_time FLOAT NOT NULL, -- 开始时间（秒）
    end_time FLOAT NOT NULL, -- 结束时间（秒）
    summary TEXT,
    keywords JSONB, -- 关键词数组
    difficulty VARCHAR(20) DEFAULT 'medium', -- easy, medium, hard
    type VARCHAR(50), -- concept, example, practice, etc.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_kp_video ON knowledge_points(video_id);
CREATE INDEX idx_kp_difficulty ON knowledge_points(difficulty);
CREATE INDEX idx_kp_time_range ON knowledge_points(video_id, start_time, end_time);
-- GIN索引用于JSONB字段的查询
CREATE INDEX idx_kp_keywords ON knowledge_points USING GIN(keywords);
```

### 2.4 WatchEvent（观看事件表）

```sql
CREATE TABLE watch_events (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    knowledge_point_id INTEGER NOT NULL,
    event_type VARCHAR(20) NOT NULL, -- play, pause, seek, replay
    timestamp FLOAT NOT NULL, -- 视频时间戳（秒）
    duration FLOAT, -- 事件持续时间（秒）
    metadata JSONB, -- 额外信息（如seek的目标时间等）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (knowledge_point_id) REFERENCES knowledge_points(id) ON DELETE CASCADE
);

-- 索引（高频写入表，索引要精简）
CREATE INDEX idx_we_user_kp ON watch_events(user_id, knowledge_point_id);
CREATE INDEX idx_we_created_at ON watch_events(created_at);
-- 分区表策略：按月分区（PostgreSQL）
-- CREATE TABLE watch_events_2025_01 PARTITION OF watch_events
--     FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 2.5 Mastery（掌握状态表）

```sql
CREATE TABLE masteries (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    knowledge_point_id INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'not_learned', -- not_learned, learning, difficult, mastered
    mastery_score FLOAT DEFAULT 0.0, -- 掌握分数（0-1）
    last_study_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (knowledge_point_id) REFERENCES knowledge_points(id) ON DELETE CASCADE,
    UNIQUE(user_id, knowledge_point_id) -- 确保一个学生对一个知识点只有一个掌握状态
);

-- 索引
CREATE INDEX idx_mastery_user ON masteries(user_id);
CREATE INDEX idx_mastery_kp ON masteries(knowledge_point_id);
CREATE INDEX idx_mastery_status ON masteries(status);
CREATE INDEX idx_mastery_user_status ON masteries(user_id, status);
```

### 2.6 Resource（补偿资源表）

```sql
CREATE TABLE resources (
    id SERIAL PRIMARY KEY,
    knowledge_point_id INTEGER NOT NULL,
    type VARCHAR(50) NOT NULL, -- knowledge_card, exercise, micro_video
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL, -- Markdown格式（知识卡片）或JSON格式（练习题）
    metadata JSONB, -- 额外信息（如视频URL、图片URL等）
    quality_score FLOAT DEFAULT 0.0, -- 质量分数（0-1）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (knowledge_point_id) REFERENCES knowledge_points(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_resource_kp ON resources(knowledge_point_id);
CREATE INDEX idx_resource_type ON resources(type);
CREATE INDEX idx_resource_quality ON resources(quality_score);
```

### 2.7 Exercise（练习题表）

```sql
CREATE TABLE exercises (
    id SERIAL PRIMARY KEY,
    resource_id INTEGER NOT NULL,
    question TEXT NOT NULL,
    options JSONB, -- 选择题选项数组
    correct_answer TEXT NOT NULL,
    explanation TEXT,
    difficulty VARCHAR(20) DEFAULT 'medium', -- easy, medium, hard
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (resource_id) REFERENCES resources(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_exercise_resource ON exercises(resource_id);
CREATE INDEX idx_exercise_difficulty ON exercises(difficulty);
```

### 2.8 LearningPath（学习路径表）

```sql
CREATE TABLE learning_paths (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL UNIQUE, -- 一个用户一个学习路径
    knowledge_point_sequence JSONB NOT NULL, -- 知识点ID序列，包含顺序和推荐原因
    current_position INTEGER DEFAULT 0, -- 当前学习位置
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_lp_user ON learning_paths(user_id);
-- GIN索引用于JSONB字段的查询
CREATE INDEX idx_lp_sequence ON learning_paths USING GIN(knowledge_point_sequence);
```

### 2.9 KnowledgePointDependency（知识点依赖关系表）

```sql
CREATE TABLE knowledge_point_dependencies (
    id SERIAL PRIMARY KEY,
    source_kp_id INTEGER NOT NULL, -- 前置知识点
    target_kp_id INTEGER NOT NULL, -- 目标知识点
    relation_type VARCHAR(20) DEFAULT 'prerequisite', -- prerequisite, related, contains
    confidence FLOAT DEFAULT 1.0, -- 关系置信度（0-1）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (source_kp_id) REFERENCES knowledge_points(id) ON DELETE CASCADE,
    FOREIGN KEY (target_kp_id) REFERENCES knowledge_points(id) ON DELETE CASCADE,
    UNIQUE(source_kp_id, target_kp_id) -- 防止重复关系
);

-- 索引
CREATE INDEX idx_kpd_source ON knowledge_point_dependencies(source_kp_id);
CREATE INDEX idx_kpd_target ON knowledge_point_dependencies(target_kp_id);
CREATE INDEX idx_kpd_type ON knowledge_point_dependencies(relation_type);
```

### 2.10 ResourcePush（资源推送记录表）

```sql
CREATE TABLE resource_pushes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    resource_id INTEGER NOT NULL,
    knowledge_point_id INTEGER NOT NULL,
    push_status VARCHAR(20) DEFAULT 'pending', -- pending, sent, read, completed
    push_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    read_time TIMESTAMP,
    feedback VARCHAR(20), -- mastered, still_difficult, null
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (resource_id) REFERENCES resources(id) ON DELETE CASCADE,
    FOREIGN KEY (knowledge_point_id) REFERENCES knowledge_points(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_rp_user ON resource_pushes(user_id);
CREATE INDEX idx_rp_kp ON resource_pushes(knowledge_point_id);
CREATE INDEX idx_rp_status ON resource_pushes(push_status);
CREATE INDEX idx_rp_push_time ON resource_pushes(push_time);
```

### 2.11 Class（班级表）

```sql
CREATE TABLE classes (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    teacher_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (teacher_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_class_teacher ON classes(teacher_id);
```

### 2.12 ClassStudent（班级学生关系表）

```sql
CREATE TABLE class_students (
    id SERIAL PRIMARY KEY,
    class_id INTEGER NOT NULL,
    student_id INTEGER NOT NULL,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE(class_id, student_id)
);

-- 索引
CREATE INDEX idx_cs_class ON class_students(class_id);
CREATE INDEX idx_cs_student ON class_students(student_id);
```

---

## 3. 索引策略

### 3.1 主键索引
- 所有表的主键自动创建索引（PRIMARY KEY）

### 3.2 外键索引
- 所有外键字段都创建索引，提高JOIN查询性能

### 3.3 查询优化索引

| 表名 | 索引字段 | 索引类型 | 理由 |
|------|---------|---------|------|
| users | email | B-tree | 登录查询 |
| users | role | B-tree | 按角色查询 |
| videos | uploader_id | B-tree | 查询教师上传的视频 |
| videos | status | B-tree | 查询解析状态 |
| knowledge_points | video_id, start_time, end_time | B-tree | 查询视频的知识点，按时间范围 |
| knowledge_points | keywords | GIN | JSONB字段的全文搜索 |
| watch_events | user_id, knowledge_point_id | B-tree | 查询学生的观看行为 |
| watch_events | created_at | B-tree | 按时间查询（支持分区） |
| masteries | user_id, status | B-tree | 查询学生的掌握状态 |
| resources | knowledge_point_id, type | B-tree | 查询知识点的资源 |
| learning_paths | knowledge_point_sequence | GIN | JSONB字段的查询 |

### 3.4 分区策略

**watch_events表按月分区**（PostgreSQL）：
```sql
-- 创建分区表
CREATE TABLE watch_events (
    id SERIAL,
    user_id INTEGER NOT NULL,
    knowledge_point_id INTEGER NOT NULL,
    event_type VARCHAR(20) NOT NULL,
    timestamp FLOAT NOT NULL,
    duration FLOAT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- 创建分区
CREATE TABLE watch_events_2025_01 PARTITION OF watch_events
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
CREATE TABLE watch_events_2025_02 PARTITION OF watch_events
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
-- ... 每月创建新分区
```

---

## 4. 外键约束设计

### 4.1 级联删除策略
- **CASCADE**：删除父记录时，自动删除子记录
  - 删除用户 → 删除该用户的所有观看事件、掌握状态、学习路径
  - 删除视频 → 删除该视频的所有知识点
  - 删除知识点 → 删除该知识点的所有资源、依赖关系

### 4.2 外键约束列表

| 子表 | 外键字段 | 父表 | 约束类型 |
|------|---------|------|---------|
| videos | uploader_id | users | CASCADE |
| knowledge_points | video_id | videos | CASCADE |
| watch_events | user_id | users | CASCADE |
| watch_events | knowledge_point_id | knowledge_points | CASCADE |
| masteries | user_id | users | CASCADE |
| masteries | knowledge_point_id | knowledge_points | CASCADE |
| resources | knowledge_point_id | knowledge_points | CASCADE |
| exercises | resource_id | resources | CASCADE |
| learning_paths | user_id | users | CASCADE |
| knowledge_point_dependencies | source_kp_id | knowledge_points | CASCADE |
| knowledge_point_dependencies | target_kp_id | knowledge_points | CASCADE |
| resource_pushes | user_id | users | CASCADE |
| resource_pushes | resource_id | resources | CASCADE |
| resource_pushes | knowledge_point_id | knowledge_points | CASCADE |

---

## 5. 数据迁移方案

### 5.1 初始版本（v1.0）
- 执行上述所有CREATE TABLE语句
- 创建所有索引
- 创建分区表（watch_events）

### 5.2 版本升级策略

#### 5.2.1 添加新字段
```sql
-- 示例：为users表添加新字段
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
CREATE INDEX idx_users_phone ON users(phone);
```

#### 5.2.2 修改字段类型
```sql
-- 示例：修改字段类型（需要先转换数据）
ALTER TABLE videos ALTER COLUMN duration TYPE DECIMAL(10,2);
```

#### 5.2.3 添加新表
```sql
-- 直接执行CREATE TABLE语句
```

#### 5.2.4 数据迁移脚本
```sql
-- 示例：迁移旧数据到新表结构
INSERT INTO new_table (field1, field2, ...)
SELECT old_field1, old_field2, ...
FROM old_table
WHERE condition;
```

### 5.3 迁移工具
- 使用**Alembic**（Python）或**Flyway**（Java）进行版本控制
- 每次数据库变更都创建迁移脚本
- 支持回滚操作

---

## 6. 数据模型说明

### 6.1 知识点依赖关系存储
使用**邻接表**方式存储知识点依赖关系：
- 优点：简单直观，查询直接
- 缺点：查询所有前置知识点需要递归查询
- 优化：可以使用**闭包表**（Closure Table）优化查询性能（后续优化）

### 6.2 观看事件高频写入优化
- **分区表**：按月分区，提高查询性能
- **批量插入**：前端批量上报，后端批量插入
- **异步处理**：写入消息队列，异步处理

### 6.3 学习路径动态更新
- 使用**JSONB**字段存储知识点序列，支持灵活的结构
- 每次更新时更新`updated_at`字段
- 支持版本历史（可选，后续优化）

### 6.4 JSONB字段使用
- `knowledge_points.keywords`：关键词数组
- `knowledge_points_sequence`：学习路径序列
- `watch_events.metadata`：事件元数据
- `resources.metadata`：资源元数据
- `exercises.options`：选择题选项

---

## 7. 数据库性能优化建议

### 7.1 查询优化
- 使用EXPLAIN分析慢查询
- 避免SELECT *，只查询需要的字段
- 使用LIMIT限制返回结果数量
- 合理使用JOIN，避免N+1查询

### 7.2 写入优化
- 批量插入使用`INSERT ... VALUES (...), (...), ...`
- 使用事务批量提交
- 对于高频写入表（watch_events），考虑异步写入

### 7.3 连接池配置
```python
# SQLAlchemy连接池配置
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_size': 10,
    'max_overflow': 20,
    'pool_timeout': 30,
    'pool_recycle': 3600
}
```

---

## 8. 数据备份策略

### 8.1 全量备份
- 每天凌晨执行全量备份
- 保留最近7天的备份

### 8.2 增量备份
- 每小时执行增量备份
- 保留最近24小时的增量备份

### 8.3 备份工具
- PostgreSQL：使用`pg_dump`和`pg_restore`
- MySQL：使用`mysqldump`

---

## 9. 下一步工作

1. ✅ 数据库ER图设计（本文档）
2. ⏳ 创建数据库迁移脚本（Alembic）
3. ⏳ 编写数据访问层代码（SQLAlchemy Models）
4. ⏳ 数据库初始化脚本
5. ⏳ 单元测试（数据库操作）

---

**文档版本**: v1.0  
**最后更新**: 2025-01-25  
**下次评审**: 待定
