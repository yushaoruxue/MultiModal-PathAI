# AI赋能职教视频个性化教学系统 - 开发规范文档

## 文档信息
- **版本**: v1.0
- **编写日期**: 2025-01-25
- **编写人**: 周东吴（队长）
- **文档状态**: 初稿

---

## 1. 代码风格规范

### 1.1 Python代码规范

#### 1.1.1 遵循PEP 8
- 使用4个空格缩进（不使用Tab）
- 每行最大长度79字符（注释和文档字符串72字符）
- 使用空行分隔函数和类
- 导入语句按标准库、第三方库、本地库分组

**好的例子**：
```python
import os
import sys
from typing import List, Dict, Optional

import numpy as np
import pandas as pd

from app.models import User, Video
from app.utils import logger
```

**坏的例子**：
```python
import os, sys, numpy as np, pandas as pd  # 一行导入多个
from app.models import *  # 使用通配符导入
```

#### 1.1.2 使用black格式化
- 使用black自动格式化代码
- 配置：`line-length = 88`

**配置文件**：`.black.toml`
```toml
[tool.black]
line-length = 88
target-version = ['py39']
include = '\.pyi?$'
```

#### 1.1.3 使用mypy类型检查
- 所有函数都要有类型注解
- 使用`typing`模块的类型提示

**好的例子**：
```python
from typing import List, Dict, Optional

def calculate_difficulty_score(
    replay_count: int,
    pause_count: int,
    thresholds: Dict[str, float]
) -> float:
    """计算困难度分数"""
    score = (replay_count / thresholds['replay']) * 0.3
    score += (pause_count / thresholds['pause']) * 0.3
    return min(score, 10.0)
```

**坏的例子**：
```python
def calculate_difficulty_score(replay_count, pause_count, thresholds):
    score = (replay_count / thresholds['replay']) * 0.3
    return score
```

#### 1.1.4 命名规范
- **变量和函数**：使用`snake_case`
- **类名**：使用`PascalCase`
- **常量**：使用`UPPER_SNAKE_CASE`
- **私有变量/函数**：使用`_single_leading_underscore`

**例子**：
```python
# 常量
MAX_RETRY_COUNT = 3
DEFAULT_TIMEOUT = 30

# 变量
user_id = 123
difficulty_score = 8.5

# 函数
def calculate_difficulty_score():
    pass

# 类
class DifficultyDetector:
    pass

# 私有方法
def _internal_helper():
    pass
```

### 1.2 JavaScript/TypeScript代码规范

#### 1.2.1 使用ESLint + Prettier
- ESLint检查代码质量
- Prettier格式化代码

**配置文件**：`.eslintrc.js`
```javascript
module.exports = {
  extends: [
    'plugin:vue/vue3-essential',
    '@vue/typescript/recommended',
    'prettier'
  ],
  rules: {
    'no-console': 'warn',
    'no-debugger': 'error'
  }
}
```

**配置文件**：`.prettierrc`
```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100
}
```

#### 1.2.2 命名规范
- **变量和函数**：使用`camelCase`
- **类名和组件**：使用`PascalCase`
- **常量**：使用`UPPER_SNAKE_CASE`
- **私有变量/函数**：使用`_singleLeadingUnderscore`

**例子**：
```typescript
// 常量
const MAX_RETRY_COUNT = 3;
const API_BASE_URL = 'https://api.example.com';

// 变量
const userId = 123;
const difficultyScore = 8.5;

// 函数
function calculateDifficultyScore() {}

// 类/组件
class DifficultyDetector {}
const VideoPlayer = () => {};

// 私有
function _internalHelper() {}
```

---

## 2. Git工作流规范

### 2.1 分支命名规范

| 分支类型 | 命名格式 | 示例 |
|---------|---------|------|
| 主分支 | `main` | `main` |
| 开发分支 | `develop` | `develop` |
| 功能分支 | `feature/功能名称` | `feature/video-upload` |
| 修复分支 | `bugfix/问题描述` | `bugfix/login-error` |
| 热修复分支 | `hotfix/问题描述` | `hotfix/critical-bug` |
| 发布分支 | `release/版本号` | `release/v1.0.0` |

### 2.2 提交信息规范（Conventional Commits）

**格式**：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**：
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**：
```
feat(video): 添加视频分片上传功能

- 支持大文件分片上传
- 支持断点续传
- 添加上传进度显示

Closes #123
```

**好的提交信息**：
```
feat(algorithm): 实现知识点切分算法
fix(api): 修复视频列表分页错误
docs(readme): 更新项目README
refactor(database): 优化数据库查询性能
```

**坏的提交信息**：
```
update
fix bug
修改代码
```

### 2.3 代码审查流程

1. **创建Pull Request**
   - 从功能分支向`develop`分支创建PR
   - PR标题要清晰描述功能
   - PR描述要包含：
     - 功能说明
     - 测试情况
     - 相关Issue

2. **代码审查**
   - 至少需要1人审查通过
   - 审查要点：
     - 代码逻辑正确性
     - 代码风格一致性
     - 是否有测试覆盖
     - 是否有安全隐患

3. **合并**
   - 审查通过后，由审查者或项目负责人合并
   - 合并前确保CI/CD通过

### 2.4 合并请求规范

**PR模板**：
```markdown
## 功能描述
简要描述本次PR的功能

## 变更内容
- [ ] 功能1
- [ ] 功能2

## 测试情况
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 手动测试通过

## 相关Issue
Closes #123

## 截图（如有）
```

---

## 3. 项目目录结构规范

### 3.1 后端项目结构（FastAPI）

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                 # 应用入口
│   ├── config.py               # 配置文件
│   ├── models/                 # 数据模型
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── video.py
│   │   └── knowledge_point.py
│   ├── schemas/                # Pydantic模型
│   │   ├── __init__.py
│   │   ├── user.py
│   │   └── video.py
│   ├── api/                    # API路由
│   │   ├── __init__.py
│   │   ├── deps.py             # 依赖注入
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── videos.py
│   │   │   ├── watch_events.py
│   │   │   └── learning_path.py
│   ├── services/               # 业务逻辑
│   │   ├── __init__.py
│   │   ├── video_service.py
│   │   └── difficulty_service.py
│   ├── utils/                  # 工具函数
│   │   ├── __init__.py
│   │   ├── logger.py
│   │   └── exceptions.py
│   └── db/                     # 数据库
│       ├── __init__.py
│       ├── session.py
│       └── base.py
├── tests/                      # 测试
│   ├── __init__.py
│   ├── test_videos.py
│   └── test_services.py
├── alembic/                    # 数据库迁移
│   ├── versions/
│   └── env.py
├── requirements.txt            # 依赖
├── .env.example               # 环境变量示例
├── .gitignore
├── Dockerfile
└── README.md
```

### 3.2 前端项目结构（Vue.js）

```
frontend/
├── src/
│   ├── main.ts                 # 入口文件
│   ├── App.vue
│   ├── assets/                 # 静态资源
│   │   ├── images/
│   │   └── styles/
│   ├── components/            # 公共组件
│   │   ├── VideoPlayer.vue
│   │   └── KnowledgePointList.vue
│   ├── views/                 # 页面
│   │   ├── Student/
│   │   │   ├── VideoPlay.vue
│   │   │   └── LearningPath.vue
│   │   └── Teacher/
│   │       └── Dashboard.vue
│   ├── router/                # 路由
│   │   └── index.ts
│   ├── store/                  # 状态管理
│   │   ├── modules/
│   │   └── index.ts
│   ├── api/                   # API调用
│   │   ├── videos.ts
│   │   └── watchEvents.ts
│   ├── utils/                 # 工具函数
│   │   ├── request.ts
│   │   └── format.ts
│   └── types/                  # TypeScript类型
│       ├── user.ts
│       └── video.ts
├── public/
├── tests/
├── .eslintrc.js
├── .prettierrc
├── package.json
├── tsconfig.json
└── vite.config.ts
```

### 3.3 AI算法模块结构

```
algorithm/
├── __init__.py
├── knowledge_point_segmenter.py
├── knowledge_point_annotator.py
├── knowledge_graph_builder.py
├── difficulty_detector.py
├── public_difficulty_detector.py
├── learning_path_generator.py
├── path_adjuster.py
├── knowledge_card_generator.py
├── exercise_generator.py
├── tests/
│   ├── test_segmenter.py
│   └── test_detector.py
├── requirements.txt
└── README.md
```

### 3.4 文档目录结构

```
docs/
├── 系统架构设计.md
├── 数据库设计.md
├── API接口规范.md
├── 开发规范.md
├── 部署文档.md
└── 用户手册.md
```

---

## 4. 测试规范

### 4.1 单元测试覆盖率要求
- **目标覆盖率**：≥80%
- **关键模块**：≥90%（算法模块、业务逻辑）

### 4.2 测试文件命名规范
- Python：`test_模块名.py`
- JavaScript/TypeScript：`模块名.test.ts`

**例子**：
```
test_knowledge_point_segmenter.py
test_difficulty_detector.py
VideoPlayer.test.ts
```

### 4.3 测试编写规范

**Python（pytest）**：
```python
import pytest
from app.services.difficulty_service import DifficultyDetector

class TestDifficultyDetector:
    def test_calculate_difficulty_score_normal(self):
        """测试正常情况下的困难度分数计算"""
        detector = DifficultyDetector()
        behavior_data = {
            'replay_count': 2,
            'pause_count': 3,
            'total_watch_time': 600,
            'knowledge_point_duration': 200
        }
        result = detector.detect(behavior_data, {})
        assert result['is_difficult'] == True
        assert 0 <= result['difficulty_score'] <= 10

    def test_calculate_difficulty_score_edge_case(self):
        """测试边界情况"""
        detector = DifficultyDetector()
        behavior_data = {
            'replay_count': 0,
            'pause_count': 0,
            'total_watch_time': 100,
            'knowledge_point_duration': 100
        }
        result = detector.detect(behavior_data, {})
        assert result['is_difficult'] == False
```

**TypeScript（Vitest）**：
```typescript
import { describe, it, expect } from 'vitest';
import { calculateDifficultyScore } from '@/utils/difficulty';

describe('calculateDifficultyScore', () => {
  it('should calculate score correctly', () => {
    const behaviorData = {
      replayCount: 2,
      pauseCount: 3,
      totalWatchTime: 600,
      knowledgePointDuration: 200
    };
    const score = calculateDifficultyScore(behaviorData);
    expect(score).toBeGreaterThanOrEqual(0);
    expect(score).toBeLessThanOrEqual(10);
  });
});
```

### 4.4 集成测试规范
- 测试完整的业务流程
- 使用测试数据库
- 测试后清理数据

---

## 5. 文档规范

### 5.1 代码注释规范

#### 5.1.1 函数注释（Google风格）

**Python**：
```python
def calculate_difficulty_score(
    replay_count: int,
    pause_count: int,
    thresholds: Dict[str, float]
) -> float:
    """计算困难度分数。
    
    Args:
        replay_count: 回放次数
        pause_count: 暂停次数
        thresholds: 阈值字典，包含replay和pause的阈值
    
    Returns:
        困难度分数（0-10）
    
    Raises:
        ValueError: 当thresholds中缺少必要键时
    
    Example:
        >>> thresholds = {'replay': 2, 'pause': 3}
        >>> score = calculate_difficulty_score(2, 3, thresholds)
        >>> print(score)
        1.0
    """
    if 'replay' not in thresholds or 'pause' not in thresholds:
        raise ValueError("thresholds must contain 'replay' and 'pause'")
    
    score = (replay_count / thresholds['replay']) * 0.3
    score += (pause_count / thresholds['pause']) * 0.3
    return min(score, 10.0)
```

**TypeScript**：
```typescript
/**
 * 计算困难度分数
 * @param replayCount - 回放次数
 * @param pauseCount - 暂停次数
 * @param thresholds - 阈值对象
 * @returns 困难度分数（0-10）
 * @throws {Error} 当thresholds中缺少必要键时
 */
function calculateDifficultyScore(
  replayCount: number,
  pauseCount: number,
  thresholds: { replay: number; pause: number }
): number {
  if (!thresholds.replay || !thresholds.pause) {
    throw new Error("thresholds must contain 'replay' and 'pause'");
  }
  
  let score = (replayCount / thresholds.replay) * 0.3;
  score += (pauseCount / thresholds.pause) * 0.3;
  return Math.min(score, 10.0);
}
```

#### 5.1.2 类注释

```python
class DifficultyDetector:
    """难点识别器。
    
    基于学生的观看行为数据识别疑难点，包括：
    - 回放次数
    - 暂停次数
    - 停留时长比
    - 快进/快退次数
    
    Attributes:
        thresholds: 判定阈值字典
        weights: 权重字典
    
    Example:
        >>> detector = DifficultyDetector()
        >>> result = detector.detect(behavior_data, kp_info)
        >>> print(result['is_difficult'])
        True
    """
    
    def __init__(self, thresholds: Optional[Dict] = None):
        """初始化难点识别器。
        
        Args:
            thresholds: 自定义阈值，如果为None则使用默认值
        """
        self.thresholds = thresholds or self._default_thresholds()
```

#### 5.1.3 复杂逻辑注释

```python
def segment_knowledge_points(asr_texts, ocr_texts):
    """知识点切分算法。
    
    算法流程：
    1. 合并ASR和OCR文本，按时间戳排序
    2. 使用滑动窗口计算语义相似度
    3. 当相似度低于阈值时，识别为话题转换点
    4. 根据话题转换点切分知识点
    5. 确保每个知识点时长在2-10分钟之间
    """
    # 步骤1：合并和排序
    merged_texts = merge_and_sort(asr_texts, ocr_texts)
    
    # 步骤2：计算相似度
    similarity_scores = []
    for i in range(len(merged_texts) - 1):
        # 使用sentence-transformers计算语义相似度
        score = calculate_similarity(
            merged_texts[i]['text'],
            merged_texts[i+1]['text']
        )
        similarity_scores.append(score)
    
    # 步骤3：识别话题转换点
    topic_shifts = detect_topic_shifts(similarity_scores, threshold=0.7)
    
    # 步骤4和5：切分知识点
    knowledge_points = split_by_shifts(merged_texts, topic_shifts)
    return knowledge_points
```

### 5.2 API文档更新规范
- 每次接口变更都要更新API文档
- 使用Swagger/OpenAPI自动生成文档
- 文档要包含请求/响应示例

### 5.3 技术文档编写规范
- 使用Markdown格式
- 包含目录
- 代码示例要有语法高亮
- 图表使用Mermaid格式

---

## 6. 安全规范

### 6.1 敏感信息处理

#### 6.1.1 环境变量
- 所有敏感信息使用环境变量
- 不要将敏感信息提交到Git

**好的做法**：
```python
import os
from dotenv import load_dotenv

load_dotenv()

API_KEY = os.getenv('API_KEY')
DATABASE_URL = os.getenv('DATABASE_URL')
```

**坏的做法**：
```python
API_KEY = "sk-1234567890abcdef"  # 硬编码
```

#### 6.1.2 .env文件
- 创建`.env.example`文件作为模板
- `.env`文件添加到`.gitignore`

**.env.example**：
```
API_KEY=your_api_key_here
DATABASE_URL=postgresql://user:password@localhost/dbname
REDIS_URL=redis://localhost:6379
```

### 6.2 SQL注入防护
- 使用ORM（SQLAlchemy），避免直接SQL拼接
- 如果必须使用原生SQL，使用参数化查询

**好的做法**：
```python
# 使用ORM
user = session.query(User).filter(User.id == user_id).first()

# 参数化查询
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
```

**坏的做法**：
```python
# SQL注入风险
query = f"SELECT * FROM users WHERE id = {user_id}"
cursor.execute(query)
```

### 6.3 XSS防护
- 前端输入输出转义
- 使用框架的自动转义功能

**Vue.js自动转义**：
```vue
<template>
  <!-- Vue自动转义 -->
  <div>{{ userInput }}</div>
  
  <!-- 如果必须使用HTML，使用v-html但要确保内容安全 -->
  <div v-html="sanitizedHtml"></div>
</template>
```

### 6.4 CSRF防护
- 使用CSRF Token
- 验证请求来源

---

## 7. 工具配置

### 7.1 .editorconfig

```ini
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.py]
indent_style = space
indent_size = 4
max_line_length = 88

[*.{js,ts,vue}]
indent_style = space
indent_size = 2
max_line_length = 100

[*.md]
trim_trailing_whitespace = false
```

### 7.2 .prettierrc（前端）

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid"
}
```

### 7.3 pyproject.toml（Python）

```toml
[tool.black]
line-length = 88
target-version = ['py39']

[tool.mypy]
python_version = "3.9"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = "test_*.py"
python_classes = "Test*"
python_functions = "test_*"
```

---

## 8. 代码提交前检查清单

### 8.1 代码质量检查
- [ ] 代码通过linter检查（ESLint/Flake8）
- [ ] 代码格式化（Prettier/Black）
- [ ] 类型检查通过（mypy/TypeScript）
- [ ] 没有未使用的导入和变量
- [ ] 没有硬编码的敏感信息

### 8.2 测试检查
- [ ] 单元测试通过
- [ ] 测试覆盖率≥80%
- [ ] 集成测试通过（如有）

### 8.3 文档检查
- [ ] 函数和类有文档字符串
- [ ] 复杂逻辑有注释
- [ ] API文档已更新（如有接口变更）
- [ ] README已更新（如有功能变更）

### 8.4 Git检查
- [ ] 提交信息符合规范
- [ ] 没有提交临时文件和调试代码
- [ ] .gitignore配置正确

---

## 9. 代码审查要点

### 9.1 功能正确性
- 代码逻辑是否正确
- 边界情况是否处理
- 错误处理是否完善

### 9.2 代码质量
- 代码是否可读
- 是否有重复代码
- 函数是否过长（建议<50行）

### 9.3 性能
- 是否有性能问题
- 数据库查询是否优化
- 是否有不必要的循环

### 9.4 安全性
- 是否有SQL注入风险
- 是否有XSS风险
- 敏感信息是否正确处理

---

## 10. 下一步工作

1. ✅ 开发规范和代码规范制定（本文档）
2. ⏳ 配置开发工具（ESLint、Prettier、Black、mypy）
3. ⏳ 创建项目目录结构
4. ⏳ 初始化Git仓库
5. ⏳ 配置CI/CD（代码检查、测试）

---

**文档版本**: v1.0  
**最后更新**: 2025-01-25  
**下次评审**: 待定
